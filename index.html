<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhiteBoard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }

        /* Animations */
        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slide-in {
            animation: slide-in 0.3s ease-out forwards;
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-custom {
            animation: spin-slow 0.5s linear infinite;
        }

        /* Utility classes */
        .tool-btn-active {
            background-color: #4f46e5;
            color: white;
            transform: translateY(-0.5rem);
            box-shadow: 0 10px 15px -3px rgba(199, 210, 254, 0.5);
        }
        .tool-btn-inactive {
            color: #6b7280;
        }
        .tool-btn-inactive:hover {
            background-color: #f3f4f6;
            color: #4f46e5;
        }
        
        /* Student Mode Styles */
        body.student-mode .teacher-only {
            display: none !important;
        }
        body.student-mode textarea {
            pointer-events: none; /* Read only */
        }
        body.student-mode .delete-btn {
            display: none !important;
        }
        
        /* Background Themes */
        .bg-theme-white { background-color: #f8fafc; }
        .bg-theme-paper { background-color: #fffbeb; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px; }
        .bg-theme-dark { background-color: #1e293b; color: #e2e8f0; }
        .bg-theme-dark textarea { color: #f1f5f9; }
        .bg-theme-dark .bg-white { background-color: #334155; border-color: #475569; }
        .bg-theme-dark .text-gray-700 { color: #e2e8f0; }
        .bg-theme-dark .text-indigo-900 { color: #818cf8; }

        canvas { touch-action: none; }
        
        /* Protractor Styles */
        .protractor {
            cursor: move;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
            user-select: none;
        }
        .protractor-handle {
            cursor: grab;
        }
        .protractor-handle:active {
            cursor: grabbing;
        }
    </style>
</head>
<body id="appBody" class="min-h-screen bg-theme-white text-slate-800 font-sans flex flex-col overflow-hidden transition-colors duration-300">

    <!-- HEADER -->
    <header class="bg-indigo-600 text-white p-4 shadow-md flex justify-between items-center z-10 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-white/20 p-2 rounded-lg">
                <i data-lucide="calendar" class="text-white w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold leading-tight flex items-center gap-2">
                    Lärarpanelen <span id="studentBadge" class="hidden bg-yellow-400 text-yellow-900 text-[10px] px-2 py-0.5 rounded-full uppercase tracking-wide font-bold">Elevvy</span>
                </h1>
                <p class="text-xs text-indigo-200 uppercase tracking-wider">Veckoplanering & Verktyg</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-indigo-100 font-mono text-sm hidden md:block" id="currentDate"></div>
            <button onclick="openShareModal()" class="teacher-only bg-indigo-500 hover:bg-indigo-400 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition shadow-sm border border-indigo-400/30">
                <i data-lucide="share-2" class="w-4 h-4"></i> Dela
            </button>
        </div>
    </header>

    <!-- ALERT BANNER -->
    <div id="alertBanner" class="hidden bg-yellow-100 border-b border-yellow-200 text-yellow-800 px-4 py-2 text-sm text-center font-medium"></div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex overflow-hidden relative">
        
        <!-- View Container -->
        <div id="mainViewContainer" class="flex-1 p-6 overflow-y-auto flex flex-col w-full">
            
            <!-- Toolbar Top -->
            <div class="flex justify-between items-end mb-4 shrink-0">
                <h2 class="text-2xl font-bold opacity-80" id="viewTitle">Veckans Planering</h2>
                
                <div class="flex items-center gap-2 teacher-only">
                    <button onclick="toggleSettings()" id="settingsBtn" class="text-sm flex items-center gap-1 px-3 py-1 rounded transition border bg-white border-gray-300 text-gray-600 hover:bg-gray-50">
                        <i data-lucide="settings" class="w-4 h-4"></i> Inställningar
                    </button>
                    <button onclick="clearBoard()" class="text-red-500 hover:text-red-700 text-sm flex items-center gap-1 px-3 py-1 hover:bg-red-50 rounded transition border border-transparent">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Rensa
                    </button>
                </div>
            </div>

            <!-- Settings Panel -->
            <div id="settingsPanel" class="hidden bg-white p-4 mb-4 rounded-xl shadow border border-gray-200 animate-fade-in shrink-0 teacher-only max-w-2xl">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-sm font-bold text-gray-500 uppercase">Inställningar</h3>
                    <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Dagar att visa</label>
                        <div class="flex flex-wrap gap-2" id="dayToggles"></div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Bakgrundstema</label>
                        <div class="flex gap-2">
                            <button onclick="setTheme('bg-theme-white')" class="w-8 h-8 rounded-full border border-gray-300 bg-slate-50 hover:ring-2 ring-indigo-500" title="Standard"></button>
                            <button onclick="setTheme('bg-theme-paper')" class="w-8 h-8 rounded-full border border-gray-300 bg-[#fffbeb] hover:ring-2 ring-indigo-500" title="Papper"></button>
                            <button onclick="setTheme('bg-theme-dark')" class="w-8 h-8 rounded-full border border-gray-600 bg-slate-800 hover:ring-2 ring-indigo-500" title="Mörkt läge"></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: DAYS GRID -->
            <div id="daysGrid" class="grid gap-4 transition-all duration-300 pb-10 flex-1" style="grid-template-columns: repeat(auto-fit, minmax(min(100%, 300px), 1fr));"></div>

            <!-- VIEW: DRAWING CANVAS -->
            <div id="drawingContainer" class="hidden flex-1 bg-white rounded-xl shadow border border-gray-200 overflow-hidden relative flex flex-col">
                <div class="p-2 border-b border-gray-200 flex items-center justify-between bg-gray-50 teacher-only overflow-x-auto">
                    <div class="flex items-center gap-2">
                        <!-- Tools -->
                        <button onclick="setDrawTool('pen')" id="tool-pen" class="p-2 rounded hover:bg-gray-200 bg-gray-200" title="Penna"><i data-lucide="pen" class="w-4 h-4"></i></button>
                        <div class="w-px h-6 bg-gray-300 mx-1"></div>
                        <button onclick="setDrawTool('rect')" id="tool-rect" class="p-2 rounded hover:bg-gray-200" title="Rektangel"><i data-lucide="square" class="w-4 h-4"></i></button>
                        <button onclick="setDrawTool('circle')" id="tool-circle" class="p-2 rounded hover:bg-gray-200" title="Cirkel"><i data-lucide="circle" class="w-4 h-4"></i></button>
                        <button onclick="setDrawTool('triangle')" id="tool-triangle" class="p-2 rounded hover:bg-gray-200" title="Likbent triangel"><i data-lucide="triangle" class="w-4 h-4"></i></button>
                        <button onclick="setDrawTool('triangle-right')" id="tool-triangle-right" class="p-2 rounded hover:bg-gray-200 flex items-center justify-center font-bold text-[10px] w-8 h-8 border border-transparent" title="Rätvinklig triangel">
                            <i data-lucide="triangle" class="w-4 h-4 transform rotate-90"></i>
                        </button>
                        
                        <div class="w-px h-6 bg-gray-300 mx-1"></div>
                        
                        <!-- Helpers -->
                        <button onclick="toggleProtractor()" id="btn-protractor" class="p-2 rounded hover:bg-gray-200" title="Vinkellinjal (Gradskiva)"><i data-lucide="ruler" class="w-4 h-4"></i></button>

                        <div class="w-px h-6 bg-gray-300 mx-1"></div>
                        
                        <!-- Colors -->
                        <div class="flex gap-1">
                            <button onclick="setDrawColor('#000000')" class="w-6 h-6 rounded-full bg-black border border-gray-300 hover:scale-110 transition"></button>
                            <button onclick="setDrawColor('#dc2626')" class="w-6 h-6 rounded-full bg-red-600 border border-gray-300 hover:scale-110 transition"></button>
                            <button onclick="setDrawColor('#2563eb')" class="w-6 h-6 rounded-full bg-blue-600 border border-gray-300 hover:scale-110 transition"></button>
                            <button onclick="setDrawColor('#16a34a')" class="w-6 h-6 rounded-full bg-green-600 border border-gray-300 hover:scale-110 transition"></button>
                        </div>
                        <div class="w-px h-6 bg-gray-300 mx-1"></div>
                        <input type="range" min="1" max="10" value="2" onchange="state.drawing.lineWidth = this.value" class="w-20" title="Penseltjocklek">
                    </div>
                    <div>
                        <button onclick="clearCanvas()" class="text-red-500 text-sm font-bold px-3 py-1 hover:bg-red-50 rounded">Rensa allt</button>
                    </div>
                </div>
                <div class="relative flex-1 bg-white cursor-crosshair overflow-hidden" id="canvasWrapper">
                    <canvas id="whiteboardCanvas" class="absolute top-0 left-0 w-full h-full"></canvas>
                    
                    <!-- PROTRACTOR OVERLAY -->
                    <div id="protractor" class="protractor hidden absolute z-50 w-[300px] h-[150px] origin-bottom" style="top: 100px; left: 100px;" onmousedown="startDragProtractor(event)" ondblclick="toggleProtractor()">
                        <!-- SVG Protractor -->
                        <svg viewBox="0 0 300 150" class="w-full h-full drop-shadow-xl">
                            <path d="M 0 150 A 150 150 0 0 1 300 150 Z" fill="rgba(255, 255, 255, 0.9)" stroke="#333" stroke-width="2"/>
                            <line x1="150" y1="150" x2="150" y2="140" stroke="#333" stroke-width="2"/> <!-- Center tick -->
                            <!-- Ticks generated visually or simplified -->
                            <g id="ticks" stroke="#555" stroke-width="1"></g>
                            <circle cx="150" cy="150" r="5" fill="#333"/>
                            
                            <!-- Rotation Handle -->
                            <circle cx="290" cy="140" r="8" fill="#ef4444" stroke="white" stroke-width="2" class="protractor-handle" onmousedown="startRotateProtractor(event)"/>
                        </svg>
                        <div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-[10px] text-gray-500 font-bold pointer-events-none">Gradskiva</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tools Sidebar -->
        <div id="toolsSidebar" class="hidden w-80 md:w-96 bg-white border-l shadow-2xl overflow-hidden z-20 absolute right-0 top-0 bottom-0 flex flex-col animate-slide-in">
            <div class="flex justify-between items-center p-4 border-b bg-gray-50 shrink-0">
                <h2 class="font-bold text-gray-500 uppercase text-xs tracking-wider">Verktygslåda</h2>
                <button onclick="closeAllTools()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="minimize-2" class="w-18 h-18"></i>
                </button>
            </div>
            <div class="overflow-y-auto p-4 flex flex-col gap-6 custom-scrollbar h-full" id="toolsContainer"></div>
        </div>

    </main>

    <!-- BOTTOM TOOLBAR -->
    <div class="bg-white border-t border-gray-200 p-3 shadow-lg flex justify-center gap-4 z-30 shrink-0 teacher-only">
        <button onclick="toggleView('board')" id="btn-view-board" class="tool-btn-active flex flex-col items-center gap-1 px-6 py-2 rounded-xl transition-all duration-200">
            <i data-lucide="layout-grid" class="w-6 h-6"></i>
            <span class="text-xs font-bold">Vecka</span>
        </button>
        <button onclick="toggleView('draw')" id="btn-view-draw" class="tool-btn-inactive flex flex-col items-center gap-1 px-6 py-2 rounded-xl transition-all duration-200">
            <i data-lucide="pen-tool" class="w-6 h-6"></i>
            <span class="text-xs font-bold">Rita</span>
        </button>
        <div class="w-px bg-gray-300 mx-2"></div>
        <button onclick="toggleTool('timer')" id="btn-timer" class="tool-btn-inactive flex flex-col items-center gap-1 px-6 py-2 rounded-xl transition-all duration-200">
            <i data-lucide="clock" class="w-6 h-6"></i>
            <span class="text-xs font-bold">Timer</span>
        </button>
        <button onclick="toggleTool('dice')" id="btn-dice" class="tool-btn-inactive flex flex-col items-center gap-1 px-6 py-2 rounded-xl transition-all duration-200">
            <i data-lucide="dices" class="w-6 h-6"></i>
            <span class="text-xs font-bold">Tärning</span>
        </button>
        <button onclick="toggleTool('groups')" id="btn-groups" class="tool-btn-inactive flex flex-col items-center gap-1 px-6 py-2 rounded-xl transition-all duration-200">
            <i data-lucide="users" class="w-6 h-6"></i>
            <span class="text-xs font-bold">Grupper</span>
        </button>
        <button onclick="toggleTool('resources')" id="btn-resources" class="tool-btn-inactive flex flex-col items-center gap-1 px-6 py-2 rounded-xl transition-all duration-200">
            <i data-lucide="paperclip" class="w-6 h-6"></i>
            <span class="text-xs font-bold">Resurser</span>
        </button>
    </div>

    <!-- MODAL: Custom Confirm -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[60] animate-fade-in">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-lg font-bold mb-2 text-gray-800">Bekräfta</h3>
            <p id="confirmMessage" class="text-gray-600 mb-6">Är du säker?</p>
            <div class="flex justify-end gap-2">
                <button onclick="closeConfirmModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Avbryt</button>
                <button onclick="handleConfirmYes()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-medium shadow-sm">Ja, rensa</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Add Resource -->
    <div id="resourceModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i data-lucide="paperclip" class="w-5 h-5"></i> Lägg till länk
            </h3>
            <form onsubmit="handleResourceSubmit(event)" class="flex flex-col gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Webbadress</label>
                    <input type="text" id="resUrl" required placeholder="https://..." class="w-full p-2 border rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Titel</label>
                    <input type="text" id="resTitle" placeholder="T.ex. Veckans quiz" class="w-full p-2 border rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="flex justify-end gap-2 mt-2">
                    <button type="button" onclick="closeResourceModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Avbryt</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 font-medium">Lägg till</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Add Image -->
    <div id="imageModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-indigo-700">
                <i data-lucide="image" class="w-5 h-5"></i> Lägg till bild
            </h3>
            <form onsubmit="handleImageSubmit(event)" class="flex flex-col gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Bildlänk</label>
                    <input type="text" id="imgUrl" placeholder="https://..." class="w-full p-2 border rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="flex items-center justify-center gap-2 text-gray-400 text-sm font-medium">
                    <div class="h-px bg-gray-200 flex-1"></div> ELLER <div class="h-px bg-gray-200 flex-1"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ladda upp (Max 500KB)</label>
                    <input type="file" id="imgUpload" accept="image/*" class="w-full text-sm text-gray-500">
                </div>
                <div class="flex justify-end gap-2 mt-2">
                    <button type="button" onclick="closeImageModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Avbryt</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 font-medium">Spara</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Add Assignment -->
    <div id="assignmentModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-indigo-700">
                <i data-lucide="list-plus" class="w-5 h-5"></i> Nytt Uppdrag
            </h3>
            <form onsubmit="handleAssignmentSubmit(event)" class="flex flex-col gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Innehåll</label>
                    <textarea id="assignText" required placeholder="Vad ska göras?" class="w-full h-32 p-2 border rounded focus:ring-2 focus:ring-indigo-500 outline-none resize-none"></textarea>
                </div>
                <div class="flex justify-end gap-2 mt-2">
                    <button type="button" onclick="closeAssignmentModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Avbryt</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 font-medium">Lägg till</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Share -->
    <div id="shareModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-indigo-800">
                <i data-lucide="share-2" class="w-5 h-5"></i> Dela med elever
            </h3>
            <div id="shareStep1">
                <p class="text-sm text-gray-600 mb-4">Skapa en länk som visar din nuvarande planering för eleverna.</p>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Länken gäller i:</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="generateShareLink(60)" class="p-2 border rounded hover:bg-indigo-50 text-sm">1 Timme</button>
                        <button onclick="generateShareLink(24*60)" class="p-2 border rounded hover:bg-indigo-50 text-sm">24 Timmar</button>
                        <button onclick="generateShareLink(7*24*60)" class="p-2 border rounded hover:bg-indigo-50 text-sm">1 Vecka</button>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button onclick="document.getElementById('shareModal').classList.add('hidden')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Avbryt</button>
                </div>
            </div>
            <div id="shareStep2" class="hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4 flex items-start gap-2">
                    <i data-lucide="check-circle" class="w-5 h-5 text-green-600 shrink-0 mt-0.5"></i>
                    <div>
                        <p class="text-sm font-bold text-green-800">Länk skapad!</p>
                        <p class="text-xs text-green-700" id="expiryText">Giltig till...</p>
                    </div>
                </div>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="shareUrlInput" readonly class="w-full p-2 bg-gray-50 border rounded text-xs text-gray-600 font-mono select-all">
                    <button id="copyBtn" onclick="copyShareLink()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 rounded shrink-0 flex items-center justify-center min-w-[40px] transition-all"><i data-lucide="copy" class="w-4 h-4"></i></button>
                </div>
                <div class="flex justify-end gap-2">
                    <button onclick="resetShareModal()" class="px-4 py-2 text-indigo-600 font-medium hover:bg-indigo-50 rounded">Ny</button>
                    <button onclick="document.getElementById('shareModal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded">Stäng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const allDays = ['måndag', 'tisdag', 'onsdag', 'torsdag', 'fredag', 'lördag', 'söndag'];
        
        let state = {
            plan: { måndag: '', tisdag: '', onsdag: '', torsdag: '', fredag: '', lördag: '', söndag: '' },
            assignments: {}, 
            visibleDays: ['måndag', 'tisdag', 'onsdag', 'torsdag', 'fredag'],
            dayResources: {},
            dayImages: {},
            globalResources: [],
            activeTools: { timer: false, dice: false, groups: false, resources: false },
            settings: { theme: 'bg-theme-white' },
            settingsOpen: false,
            // Drawing
            drawing: { tool: 'pen', color: '#000000', lineWidth: 2, isDrawing: false, startX: 0, startY: 0, snapshot: null },
            // Tools
            timer: { mode: 'timer', time: 0, isRunning: false, inputMinutes: 5, intervalId: null },
            dice: { count: 1, results: [1], isRolling: false },
            groups: { names: '', count: 2, result: [], generated: false },
            // UI Temp
            activeDayForResource: null,
            activeAssignmentId: null,
            activeDayForImage: null,
            activeDayForAssignment: null,
            currentView: 'board',
            // Protractor
            protractor: { active: false, x: 100, y: 100, rotation: 0, isDragging: false, isRotating: false, lastX: 0, lastY: 0 }
        };

        let isStudentMode = false;
        let confirmCallback = null;

        // --- HELPER: BASE64 ---
        function utf8_to_b64(str) { return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1))); }
        function b64_to_utf8(str) { return decodeURIComponent(Array.prototype.map.call(atob(str), (c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); }
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // --- INIT ---
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const shareData = params.get('data');
            
            if (shareData) {
                try {
                    const decoded = JSON.parse(b64_to_utf8(shareData));
                    if (decoded.expiry && Date.now() > decoded.expiry) {
                        showExpiryError();
                        return;
                    }
                    state.plan = decoded.plan;
                    state.assignments = decoded.assignments || {};
                    state.visibleDays = decoded.visibleDays;
                    state.dayResources = decoded.dayResources;
                    state.dayImages = decoded.dayImages || {};
                    state.settings = decoded.settings || { theme: 'bg-theme-white' };
                    state.globalResources = []; 
                    isStudentMode = true;
                    enableStudentMode(decoded.expiry);
                } catch (e) { console.error("Invalid share link", e); }
            } else {
                loadState();
            }

            applyTheme(state.settings.theme);
            renderHeaderDate();
            renderBoard();
            renderSettingsToggles();
            renderTools(); 
            updateToolbarUI();
            initCanvas();
            renderProtractorTicks();
            setupProtractorEvents();
            lucide.createIcons();
        };

        function showExpiryError() { document.body.innerHTML = `<div class="min-h-screen flex items-center justify-center bg-gray-100 p-4 text-center"><h1 class="text-xl font-bold">Länken har gått ut</h1></div>`; }
        function enableStudentMode(expiry) {
            document.body.classList.add('student-mode');
            document.getElementById('studentBadge').classList.remove('hidden');
            const date = new Date(expiry);
            document.getElementById('alertBanner').innerHTML = `Delad vy giltig till ${date.toLocaleDateString()} kl ${date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}.`;
            document.getElementById('alertBanner').classList.remove('hidden');
        }
        function loadState() {
            if(localStorage.getItem('lessonPlan')) state.plan = JSON.parse(localStorage.getItem('lessonPlan'));
            if(localStorage.getItem('assignments')) state.assignments = JSON.parse(localStorage.getItem('assignments'));
            if(localStorage.getItem('visibleDays')) state.visibleDays = JSON.parse(localStorage.getItem('visibleDays'));
            if(localStorage.getItem('dayResources')) state.dayResources = JSON.parse(localStorage.getItem('dayResources'));
            if(localStorage.getItem('dayImages')) state.dayImages = JSON.parse(localStorage.getItem('dayImages'));
            if(localStorage.getItem('globalResources')) state.globalResources = JSON.parse(localStorage.getItem('globalResources'));
            if(localStorage.getItem('appSettings')) state.settings = JSON.parse(localStorage.getItem('appSettings'));
        }
        function renderHeaderDate() { document.getElementById('currentDate').textContent = new Date().toLocaleDateString('sv-SE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }

        // --- CONFIRMATION MODAL SYSTEM ---
        function showConfirm(msg, callback) {
            document.getElementById('confirmMessage').textContent = msg;
            confirmCallback = callback;
            document.getElementById('confirmModal').classList.remove('hidden');
        }
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            confirmCallback = null;
        }
        function handleConfirmYes() {
            if(confirmCallback) confirmCallback();
            closeConfirmModal();
        }

        // --- THEME/VIEWS ---
        function setTheme(theme) { state.settings.theme = theme; localStorage.setItem('appSettings', JSON.stringify(state.settings)); applyTheme(theme); }
        function applyTheme(theme) { document.getElementById('appBody').className = `min-h-screen ${theme} text-slate-800 font-sans flex flex-col overflow-hidden transition-colors duration-300`; }
        function toggleView(view) {
            state.currentView = view;
            document.getElementById('daysGrid').classList.toggle('hidden', view !== 'board');
            document.getElementById('drawingContainer').classList.toggle('hidden', view !== 'draw');
            document.getElementById('viewTitle').textContent = view === 'board' ? 'Veckans Planering' : 'Rit-tavla';
            document.getElementById('btn-view-board').className = view === 'board' ? 'tool-btn-active flex flex-col items-center gap-1 px-6 py-2 rounded-xl transition-all duration-200' : 'tool-btn-inactive flex flex-col items-center gap-1 px-6 py-2 rounded-xl transition-all duration-200';
            document.getElementById('btn-view-draw').className = view === 'draw' ? 'tool-btn-active flex flex-col items-center gap-1 px-6 py-2 rounded-xl transition-all duration-200' : 'tool-btn-inactive flex flex-col items-center gap-1 px-6 py-2 rounded-xl transition-all duration-200';
            if(view === 'draw') resizeCanvas();
        }

        // --- BOARD RENDER ---
        function renderBoard() {
            const grid = document.getElementById('daysGrid'); grid.innerHTML = '';
            state.visibleDays.forEach(day => {
                const hasText = state.plan[day] && state.plan[day].trim().length > 0;
                const assignments = state.assignments[day] || [];
                const card = document.createElement('div');
                card.className = "flex flex-col bg-white rounded-xl shadow-sm border border-slate-200 h-full min-h-[400px] overflow-hidden transition hover:shadow-md animate-fade-in group";
                
                let assignHtml = '';
                if(assignments.length > 0 || !isStudentMode) {
                    assignHtml = `<div class="bg-white px-3 pb-3"><div class="flex items-center justify-between mb-2 mt-2"><h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Uppdrag / Lektioner</h4><button onclick="openAssignmentModal('${day}')" class="teacher-only text-indigo-600 hover:bg-indigo-50 p-1 rounded"><i data-lucide="plus" class="w-4 h-4"></i></button></div><div class="flex flex-col">${assignments.map(a => `<div class="bg-indigo-50/50 border border-indigo-100 rounded p-2 mb-2 relative group/task"><p class="text-sm text-indigo-900 whitespace-pre-wrap">${a.text}</p>${a.links && a.links.length > 0 ? `<div class="mt-2 flex flex-col gap-1">${a.links.map(l => generateResourceItemHtml(l, day, a.id, true)).join('')}</div>` : ''}<div class="mt-2 flex justify-end gap-2 opacity-0 group-hover/task:opacity-100 transition-opacity teacher-only"><button onclick="openResourceModal('${day}', ${a.id})" class="text-xs text-indigo-600 hover:underline flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Länk</button><button onclick="deleteAssignment('${day}', ${a.id})" class="text-xs text-red-500 hover:underline">Radera</button></div></div>`).join('')}</div></div>`;
                }

                let resHtml = '';
                if(state.dayResources[day] && state.dayResources[day].length > 0) {
                    resHtml = `<div class="px-3 pb-3 pt-2 bg-slate-50 border-t border-slate-100 max-h-40 overflow-y-auto custom-scrollbar"><h5 class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Dagslänkar</h5><div class="flex flex-col gap-1">${state.dayResources[day].map(r => generateResourceItemHtml(r, day)).join('')}</div></div>`;
                }

                card.innerHTML = `
                    <div class="bg-indigo-50 p-3 border-b border-indigo-100 flex justify-between items-center shrink-0">
                        <div class="flex items-center gap-2"><span class="capitalize font-bold text-indigo-900">${day}</span><span id="dot-${day}" class="w-1.5 h-1.5 bg-green-400 rounded-full ${hasText ? '' : 'hidden'}"></span></div>
                        <div class="flex gap-1 teacher-only">
                             <button onclick="openImageModal('${day}')" class="p-1 text-indigo-400 hover:text-indigo-700 hover:bg-indigo-100 rounded transition"><i data-lucide="image" class="w-4 h-4"></i></button>
                             <button onclick="openResourceModal('${day}', null)" class="p-1 text-indigo-400 hover:text-indigo-700 hover:bg-indigo-100 rounded transition"><i data-lucide="paperclip" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    ${state.dayImages[day] ? `<div class="relative group/img bg-slate-50 border-b border-slate-100"><img src="${state.dayImages[day]}" class="w-full h-auto max-h-48 object-contain p-2"><button onclick="deleteImage('${day}')" class="delete-btn absolute top-2 right-2 bg-red-500 text-white p-1 rounded shadow-md opacity-0 group-hover/img:opacity-100 transition-opacity teacher-only"><i data-lucide="x" class="w-3 h-3"></i></button></div>` : ''}
                    <div class="flex-1 flex flex-col min-h-[150px]">
                        <textarea class="flex-1 p-4 w-full resize-none focus:outline-none focus:bg-yellow-50/20 text-gray-700 font-medium leading-relaxed custom-scrollbar bg-transparent" placeholder="${isStudentMode ? 'Ingen planering...' : `Anteckningar...`}" ${isStudentMode ? 'readonly' : ''} oninput="updatePlan('${day}', this.value)">${state.plan[day] || ''}</textarea>
                    </div>
                    ${assignHtml}
                    ${resHtml}
                `;
                grid.appendChild(card);
            });
            lucide.createIcons();
        }
        function updatePlan(d,t) { state.plan[d]=t; localStorage.setItem('lessonPlan', JSON.stringify(state.plan)); document.getElementById(`dot-${d}`).classList.toggle('hidden', t.trim().length===0); }

        // --- ASSIGNMENTS ---
        function openAssignmentModal(d) { state.activeDayForAssignment=d; document.getElementById('assignmentModal').classList.remove('hidden'); document.getElementById('assignText').focus(); }
        function closeAssignmentModal() { document.getElementById('assignmentModal').classList.add('hidden'); document.getElementById('assignText').value=''; state.activeDayForAssignment=null; }
        function handleAssignmentSubmit(e) { e.preventDefault(); const t=document.getElementById('assignText').value; if(t&&state.activeDayForAssignment){ if(!state.assignments[state.activeDayForAssignment])state.assignments[state.activeDayForAssignment]=[]; state.assignments[state.activeDayForAssignment].push({id:Date.now(),text:t,links:[]}); localStorage.setItem('assignments',JSON.stringify(state.assignments)); renderBoard(); } closeAssignmentModal(); }
        
        function deleteAssignment(d,id) { 
            showConfirm('Ta bort uppdraget?', () => {
                state.assignments[d]=state.assignments[d].filter(a=>a.id!==id); 
                localStorage.setItem('assignments',JSON.stringify(state.assignments)); 
                renderBoard(); 
            });
        }

        // --- DRAWING ---
        let canvas, ctx;
        function initCanvas() {
            canvas = document.getElementById('whiteboardCanvas'); ctx = canvas.getContext('2d');
            window.addEventListener('resize', resizeCanvas);
            canvas.addEventListener('mousedown', startDrawing); canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing); canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', (e)=>{e.preventDefault(); const t=e.touches[0]; canvas.dispatchEvent(new MouseEvent('mousedown',{clientX:t.clientX,clientY:t.clientY}));}, {passive:false});
            canvas.addEventListener('touchmove', (e)=>{e.preventDefault(); const t=e.touches[0]; canvas.dispatchEvent(new MouseEvent('mousemove',{clientX:t.clientX,clientY:t.clientY}));}, {passive:false});
            canvas.addEventListener('touchend', ()=>canvas.dispatchEvent(new MouseEvent('mouseup')));
        }
        function resizeCanvas() {
            if(state.currentView!=='draw') return;
            const p=document.getElementById('canvasWrapper'); const tmp=document.createElement('canvas');
            tmp.width=canvas.width; tmp.height=canvas.height; tmp.getContext('2d').drawImage(canvas,0,0);
            canvas.width=p.clientWidth; canvas.height=p.clientHeight; ctx.drawImage(tmp,0,0); ctx.lineCap='round'; ctx.lineJoin='round';
        }
        function setDrawTool(t) { state.drawing.tool=t; ['pen','rect','circle','triangle','triangle-right'].forEach(x=>document.getElementById('tool-'+x).classList.remove('bg-gray-300')); document.getElementById('tool-'+t).classList.add('bg-gray-300'); }
        function setDrawColor(c) { state.drawing.color=c; }
        
        function clearCanvas() { 
            if(ctx) {
                showConfirm("Vill du rensa hela ritytan?", () => {
                    ctx.clearRect(0,0,canvas.width,canvas.height); 
                });
            }
        }
        
        function startDrawing(e) { 
            if(state.protractor.isDragging || state.protractor.isRotating) return; // Don't draw when moving tools
            state.drawing.isDrawing=true; 
            const r=canvas.getBoundingClientRect(); 
            state.drawing.startX=e.clientX-r.left; 
            state.drawing.startY=e.clientY-r.top; 
            if(state.drawing.tool!=='pen') state.drawing.snapshot=ctx.getImageData(0,0,canvas.width,canvas.height); 
            else { ctx.beginPath(); ctx.moveTo(state.drawing.startX, state.drawing.startY); } 
        }
        function draw(e) {
            if(!state.drawing.isDrawing) return; 
            const r=canvas.getBoundingClientRect(); 
            const x=e.clientX-r.left; 
            const y=e.clientY-r.top;
            ctx.lineWidth=state.drawing.lineWidth; 
            ctx.strokeStyle=state.drawing.color; 
            ctx.fillStyle=state.drawing.color;
            
            if(state.drawing.tool==='pen') { 
                ctx.lineTo(x,y); ctx.stroke(); 
            } else {
                ctx.putImageData(state.drawing.snapshot,0,0); ctx.beginPath();
                if(state.drawing.tool==='rect') {
                    ctx.rect(state.drawing.startX,state.drawing.startY,x-state.drawing.startX,y-state.drawing.startY);
                } else if(state.drawing.tool==='circle') { 
                    const rad=Math.sqrt(Math.pow(x-state.drawing.startX,2)+Math.pow(y-state.drawing.startY,2)); 
                    ctx.arc(state.drawing.startX,state.drawing.startY,rad,0,2*Math.PI); 
                } else if(state.drawing.tool==='triangle') { 
                    ctx.moveTo(state.drawing.startX,state.drawing.startY); 
                    ctx.lineTo(x,y); 
                    ctx.lineTo(state.drawing.startX-(x-state.drawing.startX),y); 
                    ctx.closePath(); 
                } else if(state.drawing.tool==='triangle-right') {
                    // Right-angled triangle drawing logic
                    ctx.moveTo(state.drawing.startX, state.drawing.startY);
                    ctx.lineTo(state.drawing.startX, y); // Vertical
                    ctx.lineTo(x, y); // Horizontal
                    ctx.closePath();
                }
                ctx.stroke();
            }
        }
        function stopDrawing() { if(state.drawing.isDrawing) { state.drawing.isDrawing=false; ctx.closePath(); } }

        // --- PROTRACTOR LOGIC ---
        function toggleProtractor() {
            const p = document.getElementById('protractor');
            const btn = document.getElementById('btn-protractor');
            state.protractor.active = !state.protractor.active;
            
            if (state.protractor.active) {
                p.classList.remove('hidden');
                btn.classList.add('bg-gray-300');
            } else {
                p.classList.add('hidden');
                btn.classList.remove('bg-gray-300');
            }
        }

        function renderProtractorTicks() {
            const g = document.getElementById('ticks');
            // Draw ticks for 180 degrees
            for (let i = 0; i <= 180; i += 10) {
                const rad = (i * Math.PI) / 180;
                // Outer radius is 150.
                const x1 = 150 + 140 * Math.cos(Math.PI + rad); // Start slightly inward
                const y1 = 150 + 140 * Math.sin(Math.PI + rad);
                const x2 = 150 + 150 * Math.cos(Math.PI + rad); // Edge
                const y2 = 150 + 150 * Math.sin(Math.PI + rad);
                
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", x1);
                line.setAttribute("y1", y1);
                line.setAttribute("x2", x2);
                line.setAttribute("y2", y2);
                line.setAttribute("stroke", "#333");
                line.setAttribute("stroke-width", i % 45 === 0 ? "2" : "1");
                g.appendChild(line);

                // Numbers
                if (i % 30 === 0 && i !== 0 && i !== 180) {
                    const tx = 150 + 125 * Math.cos(Math.PI + rad);
                    const ty = 150 + 125 * Math.sin(Math.PI + rad);
                    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    text.setAttribute("x", tx);
                    text.setAttribute("y", ty);
                    text.setAttribute("text-anchor", "middle");
                    text.setAttribute("dominant-baseline", "middle");
                    text.setAttribute("fill", "#666");
                    text.setAttribute("font-size", "10");
                    text.textContent = i;
                    // Fix text rotation to be readable? Nah, straightforward is fine for simple tool.
                    g.appendChild(text);
                }
            }
        }

        function setupProtractorEvents() {
            const p = document.getElementById('protractor');
            
            window.addEventListener('mousemove', (e) => {
                if (state.protractor.isDragging) {
                    e.preventDefault();
                    const dx = e.clientX - state.protractor.lastX;
                    const dy = e.clientY - state.protractor.lastY;
                    state.protractor.x += dx;
                    state.protractor.y += dy;
                    p.style.left = state.protractor.x + 'px';
                    p.style.top = state.protractor.y + 'px';
                    state.protractor.lastX = e.clientX;
                    state.protractor.lastY = e.clientY;
                } else if (state.protractor.isRotating) {
                    e.preventDefault();
                    // Calculate angle from center of protractor
                    // Center is current X + 150, current Y + 150
                    // Actually origin-bottom means pivot is at bottom center (150, 150 inside div)
                    // Visual center on screen:
                    const rect = p.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height; // Pivot is bottom center
                    
                    const mouseX = e.clientX;
                    const mouseY = e.clientY;
                    
                    const angleRad = Math.atan2(mouseY - centerY, mouseX - centerX);
                    const angleDeg = angleRad * (180 / Math.PI) + 90; // Adjust offset
                    
                    state.protractor.rotation = angleDeg;
                    p.style.transform = `rotate(${angleDeg}deg)`;
                }
            });

            window.addEventListener('mouseup', () => {
                state.protractor.isDragging = false;
                state.protractor.isRotating = false;
            });
        }

        function startDragProtractor(e) {
            if (e.target.classList.contains('protractor-handle')) return; // Let rotate handle take over
            state.protractor.isDragging = true;
            state.protractor.lastX = e.clientX;
            state.protractor.lastY = e.clientY;
        }

        function startRotateProtractor(e) {
            e.stopPropagation();
            state.protractor.isRotating = true;
        }

        // --- TOOLS ---
        function toggleTool(t) { state.activeTools[t] = !state.activeTools[t]; updateToolbarUI(); renderTools(); }
        function closeAllTools() { for(let k in state.activeTools) state.activeTools[k]=false; updateToolbarUI(); renderTools(); }
        function updateToolbarUI() {
            document.getElementById('toolsSidebar').classList.toggle('hidden', !Object.values(state.activeTools).some(x=>x));
            ['timer','dice','groups','resources'].forEach(t => {
                const b = document.getElementById('btn-'+t);
                b.className = state.activeTools[t] ? 'tool-btn-active flex flex-col items-center gap-1 px-6 py-2 rounded-xl transition-all duration-200' : 'tool-btn-inactive flex flex-col items-center gap-1 px-6 py-2 rounded-xl transition-all duration-200';
            });
        }
        function renderTools() {
            const c = document.getElementById('toolsContainer'); c.innerHTML = '';
            if(state.activeTools.timer) c.appendChild(createTimerElement());
            if(state.activeTools.dice) c.appendChild(createDiceElement());
            if(state.activeTools.groups) c.appendChild(createGroupsElement());
            if(state.activeTools.resources) c.appendChild(createResourcesElement());
            lucide.createIcons();
        }

        // --- TIMER TOOL ---
        function createTimerElement() {
            const div = document.createElement('div'); div.className = "bg-white p-4 rounded-xl shadow-lg border-2 border-indigo-100 flex flex-col gap-4 animate-fade-in";
            const min = Math.floor(state.timer.time/60); const sec = state.timer.time%60; const timeStr = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
            const isRed = state.timer.mode === 'countdown' && state.timer.time === 0;
            div.innerHTML = `
                <div class="flex justify-between items-center border-b pb-2"><h3 class="font-bold text-indigo-800 flex items-center gap-2"><i data-lucide="clock" class="w-5 h-5"></i> Tidtagare</h3><div class="flex gap-2 text-sm bg-gray-100 p-1 rounded-lg"><button onclick="setTimerMode('timer')" class="px-3 py-1 rounded ${state.timer.mode==='timer'?'bg-indigo-600 text-white':'text-gray-600 hover:bg-gray-200'}">Upp</button><button onclick="setTimerMode('countdown')" class="px-3 py-1 rounded ${state.timer.mode==='countdown'?'bg-indigo-600 text-white':'text-gray-600 hover:bg-gray-200'}">Ner</button></div></div>
                <div class="text-center py-2"><div class="text-6xl font-mono font-bold tracking-wider ${isRed?'text-red-500 animate-pulse':'text-gray-800'}">${timeStr}</div></div>
                ${state.timer.mode==='countdown'&&!state.timer.isRunning?`<div class="flex items-center justify-center gap-2"><button onclick="adjustTimerInput(-1)" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="minus" class="w-4 h-4"></i></button><span class="font-bold w-16 text-center">${state.timer.inputMinutes} min</span><button onclick="adjustTimerInput(1)" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="plus" class="w-4 h-4"></i></button><button onclick="resetTimer()" class="text-xs text-indigo-600 underline ml-2">Sätt</button></div>`:''}
                <div class="flex justify-center gap-4"><button onclick="toggleTimer()" class="flex items-center gap-2 px-6 py-2 rounded-lg font-bold transition-colors ${state.timer.isRunning?'bg-amber-100 text-amber-700':'bg-green-100 text-green-700'}">${state.timer.isRunning?'<i data-lucide="pause" class="w-5 h-5"></i> Pausa':'<i data-lucide="play" class="w-5 h-5"></i> Starta'}</button><button onclick="resetTimer()" class="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 font-medium"><i data-lucide="rotate-ccw" class="w-5 h-5"></i> Noll</button></div>`;
            return div;
        }
        function setTimerMode(m){state.timer.mode=m; state.timer.isRunning=false; clearInterval(state.timer.intervalId); state.timer.time=m==='countdown'?state.timer.inputMinutes*60:0; renderTools();}
        function adjustTimerInput(d){state.timer.inputMinutes=Math.max(1,state.timer.inputMinutes+d); state.timer.time=state.timer.inputMinutes*60; renderTools();}
        function toggleTimer(){if(state.timer.isRunning){clearInterval(state.timer.intervalId); state.timer.isRunning=false;}else{state.timer.isRunning=true; state.timer.intervalId=setInterval(()=>{if(state.timer.mode==='countdown'){if(state.timer.time>0)state.timer.time--;}else{state.timer.time++;}renderTools();},1000);}renderTools();}
        function resetTimer(){state.timer.isRunning=false; clearInterval(state.timer.intervalId); state.timer.time=state.timer.mode==='countdown'?state.timer.inputMinutes*60:0; renderTools();}

        // --- DICE TOOL ---
        function createDiceElement() {
            const div = document.createElement('div'); div.className = "bg-white p-4 rounded-xl shadow-lg border-2 border-indigo-100 flex flex-col gap-4 animate-fade-in";
            const renderDots = (val) => {
                const pos = {1:[4],2:[0,8],3:[0,4,8],4:[0,2,6,8],5:[0,2,4,6,8],6:[0,2,3,5,6,8]}; let h='';
                for(let i=0;i<9;i++) h+=`<div class="flex justify-center items-center">${pos[val].includes(i)?'<div class="w-2.5 h-2.5 bg-black rounded-full shadow-sm"></div>':''}</div>`;
                return `<div class="w-16 h-16 bg-white border-2 border-gray-300 rounded-xl shadow-md grid grid-cols-3 grid-rows-3 p-2 gap-1 ${state.dice.isRolling?'animate-spin-custom':''}">${h}</div>`;
            };
            div.innerHTML = `<div class="flex justify-between items-center border-b pb-2"><h3 class="font-bold text-indigo-800 flex items-center gap-2"><i data-lucide="dices" class="w-5 h-5"></i> Tärning</h3><div class="flex items-center gap-2 bg-gray-50 rounded-lg p-1"><button onclick="adjustDice(-1)" class="p-1 hover:bg-gray-200 rounded"><i data-lucide="minus" class="w-3.5 h-3.5"></i></button><span class="font-bold w-4 text-center">${state.dice.count}</span><button onclick="adjustDice(1)" class="p-1 hover:bg-gray-200 rounded"><i data-lucide="plus" class="w-3.5 h-3.5"></i></button></div></div><div class="flex flex-wrap justify-center gap-4 py-4 min-h-[100px] items-center bg-green-50 rounded-xl border border-green-100">${state.dice.results.map(r=>renderDots(r)).join('')}</div><button onclick="rollDice()" ${state.dice.isRolling?'disabled':''} class="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg hover:bg-indigo-700 transition active:scale-95 disabled:opacity-50">${state.dice.isRolling?'Rullar...':'Kasta tärning'}</button>`;
            return div;
        }
        function adjustDice(d){state.dice.count=Math.max(1,Math.min(5,state.dice.count+d)); state.dice.results=Array(state.dice.count).fill(1); renderTools();}
        function rollDice(){state.dice.isRolling=true; renderTools(); const int=setInterval(()=>{state.dice.results=Array.from({length:state.dice.count},()=>Math.floor(Math.random()*6)+1);},100); setTimeout(()=>{clearInterval(int); state.dice.results=Array.from({length:state.dice.count},()=>Math.floor(Math.random()*6)+1); state.dice.isRolling=false; renderTools();},800);}

        // --- GROUPS TOOL ---
        function createGroupsElement() {
            const div = document.createElement('div'); div.className = "bg-white p-4 rounded-xl shadow-lg border-2 border-indigo-100 flex flex-col gap-4 animate-fade-in max-h-[500px] overflow-hidden";
            let c = '';
            if(!state.groups.generated) {
                c=`<div class="flex flex-col gap-3"><div><label class="text-xs font-bold text-gray-500 uppercase">Namnlista (en per rad)</label><textarea id="groupNamesInput" oninput="state.groups.names=this.value" placeholder="Anna&#10;Bertil..." class="w-full h-32 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-300 resize-none text-sm">${state.groups.names}</textarea></div><div class="flex items-center justify-between bg-gray-50 p-2 rounded-lg"><span class="text-sm font-medium">Antal grupper:</span><div class="flex items-center gap-2"><button onclick="adjustGroupCount(-1)" class="p-1 bg-white border rounded hover:bg-gray-100"><i data-lucide="minus" class="w-3.5 h-3.5"></i></button><span class="font-bold w-6 text-center">${state.groups.count}</span><button onclick="adjustGroupCount(1)" class="p-1 bg-white border rounded hover:bg-gray-100"><i data-lucide="plus" class="w-3.5 h-3.5"></i></button></div></div><button onclick="generateGroups()" class="bg-indigo-600 text-white font-bold py-2 rounded-lg hover:bg-indigo-700 disabled:opacity-50" ${state.groups.names.trim()?'':'disabled'}>Skapa grupper</button></div>`;
            } else {
                c=`<div class="overflow-y-auto pr-1 custom-scrollbar"><div class="grid grid-cols-2 gap-3">${state.groups.result.map((grp,i)=>`<div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100"><h4 class="font-bold text-indigo-700 text-sm mb-1">Grupp ${i+1}</h4><ul class="text-sm text-gray-700 space-y-1">${grp.map(n=>`<li class="flex items-center gap-1"><div class="w-1.5 h-1.5 bg-indigo-300 rounded-full"></div>${n}</li>`).join('')}</ul></div>`).join('')}</div><button onclick="state.groups.generated=false;renderTools();" class="w-full mt-4 bg-indigo-100 text-indigo-700 font-bold py-2 rounded-lg hover:bg-indigo-200 flex items-center justify-center gap-2"><i data-lucide="rotate-ccw" class="w-4 h-4"></i> Slumpa igen</button></div>`;
            }
            div.innerHTML=`<div class="flex justify-between items-center border-b pb-2"><h3 class="font-bold text-indigo-800 flex items-center gap-2"><i data-lucide="users" class="w-5 h-5"></i> Gruppgenerator</h3>${state.groups.generated?`<button onclick="state.groups.generated=false;renderTools();" class="text-sm text-indigo-600 hover:underline">Ändra</button>`:''}</div>${c}`;
            return div;
        }
        function adjustGroupCount(d){state.groups.count=Math.max(2,state.groups.count+d); renderTools();}
        function generateGroups(){const l=state.groups.names.split(/[\n,]+/).map(n=>n.trim()).filter(n=>n.length>0); if(l.length===0)return; for(let i=l.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[l[i],l[j]]=[l[j],l[i]];} const g=Array.from({length:state.groups.count},()=>[]); l.forEach((n,i)=>g[i%state.groups.count].push(n)); state.groups.result=g; state.groups.generated=true; renderTools();}

        // --- RESOURCES TOOL ---
        function createResourcesElement() {
            const div = document.createElement('div'); div.className = "bg-white p-4 rounded-xl shadow-lg border-2 border-indigo-100 flex flex-col gap-4 animate-fade-in h-full";
            div.innerHTML=`<div class="flex justify-between items-center border-b pb-2"><h3 class="font-bold text-indigo-800 flex items-center gap-2"><i data-lucide="paperclip" class="w-5 h-5"></i> Resurser</h3><button onclick="openResourceModal(null)" class="p-1 bg-indigo-100 text-indigo-600 rounded hover:bg-indigo-200"><i data-lucide="plus" class="w-4 h-4"></i></button></div><div class="overflow-y-auto flex-1 custom-scrollbar pr-1">${state.globalResources.length===0?'<div class="text-center text-gray-400 text-sm py-8 italic">Inga resurser ännu.</div>':''}<div class="flex flex-col gap-1">${state.globalResources.map(r=>generateResourceItemHtml(r,null)).join('')}</div></div>`;
            return div;
        }

        // --- RESOURCES/IMAGES LOGIC ---
        function openResourceModal(day, assignmentId) { state.activeDayForResource=day; state.activeAssignmentId=assignmentId; document.getElementById('resourceModal').classList.remove('hidden'); document.getElementById('resUrl').focus(); }
        function closeResourceModal() { document.getElementById('resourceModal').classList.add('hidden'); document.getElementById('resUrl').value=''; document.getElementById('resTitle').value=''; state.activeDayForResource=null; state.activeAssignmentId=null; }
        function handleResourceSubmit(e) { e.preventDefault(); const u=document.getElementById('resUrl').value; const t=document.getElementById('resTitle').value||u; const nr={id:Date.now(),url:u,title:t}; if(state.activeDayForResource){if(state.activeAssignmentId){const da=state.assignments[state.activeDayForResource]; const ta=da.find(a=>a.id===state.activeAssignmentId); if(ta){if(!ta.links)ta.links=[]; ta.links.push(nr); localStorage.setItem('assignments',JSON.stringify(state.assignments));}}else{if(!state.dayResources[state.activeDayForResource])state.dayResources[state.activeDayForResource]=[]; state.dayResources[state.activeDayForResource].push(nr); localStorage.setItem('dayResources',JSON.stringify(state.dayResources));} renderBoard();}else{state.globalResources.push(nr); localStorage.setItem('globalResources',JSON.stringify(state.globalResources)); renderTools();} closeResourceModal(); }
        function generateResourceItemHtml(item, day, assignId, compact) {
            const isEmb = item.url.includes('docs.google.com/forms')||item.url.includes('youtube')||item.url.includes('youtu.be'); let ico='link'; if(item.url.includes('forms'))ico='file-text'; if(item.url.includes('you'))ico='youtube';
            const delCall = assignId ? `deleteAssignmentResource('${day}', ${assignId}, ${item.id})` : `deleteResource(${item.id}, '${day||''}')`;
            return `<div class="bg-white border border-gray-200 rounded p-1.5 mb-1 text-xs shadow-sm flex flex-col group ${compact?'':'p-2 text-sm'}"><div class="flex justify-between items-center gap-2"><div class="flex items-center gap-2 overflow-hidden"><i data-lucide="${ico}" class="w-3 h-3 text-indigo-500 shrink-0"></i><a href="${item.url}" target="_blank" class="font-medium text-gray-700 hover:text-indigo-600 truncate">${item.title}</a></div><div class="flex gap-1 shrink-0">${isEmb?`<button onclick="toggleEmbed('${item.id}')" class="px-1.5 py-0.5 rounded border bg-gray-50 text-gray-600">Visa</button>`:''} <button onclick="${delCall}" class="text-gray-400 hover:text-red-500 teacher-only opacity-0 group-hover:opacity-100"><i data-lucide="trash" class="w-3 h-3"></i></button></div></div><div id="embed-${item.id}" class="hidden mt-2 relative pt-[56.25%] w-full bg-gray-100 rounded overflow-hidden"></div></div>`;
        }
        function deleteAssignmentResource(d,aid,rid){showConfirm('Ta bort länk?', ()=>{const l=state.assignments[d]; const t=l.find(a=>a.id===aid); if(t){t.links=t.links.filter(x=>x.id!==rid); localStorage.setItem('assignments',JSON.stringify(state.assignments)); renderBoard();}});}
        function deleteResource(id,d){showConfirm('Ta bort länk?', ()=>{if(d&&d!=='null'){state.dayResources[d]=state.dayResources[d].filter(r=>r.id!=id); localStorage.setItem('dayResources',JSON.stringify(state.dayResources)); renderBoard();}else{state.globalResources=state.globalResources.filter(r=>r.id!=id); localStorage.setItem('globalResources',JSON.stringify(state.globalResources)); renderTools();}});}
        function toggleEmbed(id){const el=document.getElementById(`embed-${id}`); if(el.innerHTML===''){let it=state.globalResources.find(r=>r.id==id); if(!it){Object.values(state.dayResources).forEach(a=>{if(!it)it=a.find(r=>r.id==id)}); if(!it){Object.values(state.assignments).forEach(d=>{if(!it)d.forEach(a=>{if(a.links){const f=a.links.find(l=>l.id==id); if(f)it=f}})})}} if(it){let s=it.url; if(s.includes('forms'))s=s.replace('/viewform','/viewform?embedded=true'); else if(s.includes('v='))s=`https://www.youtube.com/embed/${s.split('v=')[1].split('&')[0]}`; else if(s.includes('youtu.be/'))s=`https://www.youtube.com/embed/${s.split('youtu.be/')[1]}`; el.innerHTML=`<iframe src="${s}" class="absolute top-0 left-0 w-full h-full" frameborder="0"></iframe>`; el.classList.remove('hidden');}}else{el.innerHTML=''; el.classList.add('hidden');}}
        
        function openImageModal(d){state.activeDayForImage=d; document.getElementById('imageModal').classList.remove('hidden');}
        function closeImageModal(){document.getElementById('imageModal').classList.add('hidden'); document.getElementById('imgUrl').value=''; document.getElementById('imgUpload').value=''; state.activeDayForImage=null;}
        async function handleImageSubmit(e){e.preventDefault(); const u=document.getElementById('imgUrl').value; const f=document.getElementById('imgUpload').files[0]; let s=u; if(f){if(f.size>500*1024)return alert('Filen för stor'); s=await readFileAsBase64(f);} if(s&&state.activeDayForImage){state.dayImages[state.activeDayForImage]=s; localStorage.setItem('dayImages',JSON.stringify(state.dayImages)); renderBoard();} closeImageModal();}
        
        function deleteImage(d) {
            showConfirm('Ta bort bild?', () => {
                delete state.dayImages[d]; 
                localStorage.setItem('dayImages',JSON.stringify(state.dayImages)); 
                renderBoard();
            });
        }

        // --- SETTINGS/SHARE ---
        function toggleSettings(){state.settingsOpen=!state.settingsOpen; document.getElementById('settingsPanel').classList.toggle('hidden',!state.settingsOpen); if(state.settingsOpen) renderSettingsToggles();}
        function renderSettingsToggles(){document.getElementById('dayToggles').innerHTML=allDays.map(d=>`<button onclick="toggleDay('${d}')" class="px-2 py-1 rounded text-xs border ${state.visibleDays.includes(d)?'bg-indigo-600 text-white':'bg-gray-100'}">${d}</button>`).join('');}
        function toggleDay(d){if(state.visibleDays.includes(d))state.visibleDays=state.visibleDays.filter(x=>x!==d); else state.visibleDays.push(d); state.visibleDays.sort((a,b)=>allDays.indexOf(a)-allDays.indexOf(b)); localStorage.setItem('visibleDays',JSON.stringify(state.visibleDays)); renderSettingsToggles(); renderBoard();}
        
        function clearBoard(){
            showConfirm('Vill du rensa allt innehåll? Det går inte att ångra.', () => {
                state.plan={}; 
                state.dayResources={}; 
                state.dayImages={}; 
                state.assignments={}; 
                localStorage.setItem('lessonPlan','{}'); 
                localStorage.setItem('assignments','{}'); 
                localStorage.setItem('dayResources','{}');
                localStorage.setItem('dayImages','{}');
                renderBoard();
            });
        }
        
        function openShareModal(){document.getElementById('shareModal').classList.remove('hidden');}
        function generateShareLink(m){const e=Date.now()+m*60000; const p={...state,expiry:e}; const s=JSON.stringify(p); if(s.length>50000&&!confirm("Stor data. Fortsätta?"))return; const enc=utf8_to_b64(s); document.getElementById('shareStep1').classList.add('hidden'); document.getElementById('shareStep2').classList.remove('hidden'); document.getElementById('shareUrlInput').value=window.location.href.split('?')[0]+'?data='+enc; document.getElementById('expiryText').innerText=new Date(e).toLocaleString();}
        
        function copyShareLink(){
            navigator.clipboard.writeText(document.getElementById('shareUrlInput').value); 
            const btn = document.getElementById('copyBtn');
            const original = btn.innerHTML;
            btn.innerHTML = '<span class="text-xs font-bold">Kopierad!</span>';
            setTimeout(() => btn.innerHTML = original, 2000);
        }
        
        function resetShareModal(){document.getElementById('shareStep1').classList.remove('hidden'); document.getElementById('shareStep2').classList.add('hidden');}
    </script>
</body>
</html>
